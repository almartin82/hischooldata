---
title: "Hawaii Enrollment Trends"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Hawaii Enrollment Trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6,
  out.width = "100%",
  message = FALSE,
  warning = FALSE,
  cache = TRUE
)
```

```{r load-packages}
library(hischooldata)
library(ggplot2)
library(dplyr)
library(scales)
```

```{r fetch-data, cache = TRUE}
# Get available years
years <- get_available_years()
if (is.list(years)) {
  max_year <- years$max_year
  min_year <- years$min_year
} else {
  max_year <- max(years)
  min_year <- min(years)
}

# Fetch data for the last 10 available years
year_range <- intersect((max_year - 9):max_year, years$years)
enr <- fetch_enr_multi(year_range, use_cache = TRUE)
enr_current <- fetch_enr(max_year, use_cache = TRUE)
```

## 1. Hawaii is America's only statewide school district

Unlike every other state, Hawaii operates as a single statewide school district with approximately 290 schools. No local school boards, no property tax funding. One state, one system.

```{r statewide-district}
statewide <- enr_current %>%
  filter(type == "STATE", grade_level == "TOTAL") %>%
  select(n_students)
stopifnot(nrow(statewide) > 0)

# Count counties (Hawaii is organized by county, not individual schools in this data)
n_counties <- enr_current %>%
  filter(type == "COUNTY", grade_level == "TOTAL") %>%
  nrow()

cat("Total students:", format(statewide$n_students, big.mark = ","), "\n")
cat("Counties served:", n_counties, "(plus Charter Schools)\n")
```

## 2. Enrollment dropped ~15,000 students since 2016

Hawaii lost nearly 15,000 students since 2016. High housing costs push families to the mainland, and birth rates are falling.

```{r n_students-decline}
state_trend <- enr %>%
  filter(type == "STATE", grade_level == "TOTAL")

stopifnot(nrow(state_trend) > 0)
print(state_trend)

ggplot(state_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = "#2C3E50") +
  geom_point(size = 3, color = "#2C3E50") +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Hawaii Public School Enrollment",
       subtitle = "Declining as families move to the mainland",
       x = "School Year", y = "Students") +
  theme_minimal(base_size = 14)
```

## 3. Enrollment by County

Hawaii's single statewide district serves four counties plus charter schools. Honolulu (Oahu) dominates enrollment, with about two-thirds of all students.

```{r county-distribution}
county_enr <- enr_current %>%
  filter(grade_level == "TOTAL", type %in% c("COUNTY", "CHARTER")) %>%
  mutate(county_label = reorder(county_name, -n_students))

stopifnot(nrow(county_enr) > 0)
print(county_enr)

ggplot(county_enr, aes(x = county_label, y = n_students)) +
  geom_col(fill = "#2C3E50") +
  scale_y_continuous(labels = comma) +
  labs(title = "Hawaii Enrollment by County",
       subtitle = "Honolulu dominates with two-thirds of students",
       x = "", y = "Students") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## 4. COVID hit enrollment hard -- 4,647 students lost in one year

When the pandemic struck, families moved to the mainland or shifted to private schools. Hawaii lost 4,647 students (2.6%) between 2020 and 2021.

```{r covid-impact}
# Show year-over-year change during COVID
covid_change <- enr %>%
  filter(end_year %in% c(2020, 2021), grade_level == "TOTAL", type == "STATE") %>%
  select(end_year, n_students)
stopifnot(nrow(covid_change) == 2)

change <- diff(covid_change$n_students)
pct_change <- change / covid_change$n_students[1] * 100
cat("Enrollment change 2020-2021:", format(change, big.mark = ","),
    sprintf("(%.1f%%)", pct_change), "\n")
```

## 5. Kindergarten is shrinking faster than high school

Hawaii's kindergarten enrollment dropped from ~13,900 to ~11,700 while Grade 9 grew. The pipeline of students entering the system is narrowing.

```{r k-vs-12}
k_trend <- enr %>%
  filter(type == "STATE", grade_level %in% c("K", "09", "12")) %>%
  mutate(grade_label = case_when(
    grade_level == "K" ~ "Kindergarten",
    grade_level == "09" ~ "Grade 9",
    grade_level == "12" ~ "Grade 12"
  ))

stopifnot(nrow(k_trend) > 0)
print(k_trend)

ggplot(k_trend, aes(x = end_year, y = n_students, color = grade_label)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma) +
  labs(title = "Kindergarten Shrinking Faster Than High School",
       subtitle = "The pipeline of students is narrowing",
       x = "School Year", y = "Students", color = "") +
  theme_minimal(base_size = 14)
```

## 6. Private school competition is fierce

Hawaii has one of the highest private school enrollment rates in the nation. Kamehameha Schools, Punahou, and Iolani draw thousands of students who might otherwise attend public schools.

```{r private-competition}
# Public enrollment as context
public_total <- enr_current %>%
  filter(type == "STATE", grade_level == "TOTAL") %>%
  pull(n_students)
stopifnot(length(public_total) == 1)

cat("Public school enrollment:", format(public_total, big.mark = ","), "\n")
cat("Estimated private school students: ~35,000\n")
cat("Private school share: ~",
    round(35000 / (public_total + 35000) * 100, 1), "%\n", sep = "")
```

## 7. Charter schools grew 25% since 2016

Hawaii's charter school enrollment grew from 10,444 to 13,094 students -- a 25% increase while overall enrollment declined.

```{r charter-growth}
charter_trend <- enr %>%
  filter(type == "CHARTER", grade_level == "TOTAL")

stopifnot(nrow(charter_trend) > 0)
print(charter_trend)

ggplot(charter_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = "#2C3E50") +
  geom_point(size = 3, color = "#2C3E50") +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Charter School Enrollment",
       subtitle = "Growing alternative to traditional public schools",
       x = "School Year", y = "Students") +
  theme_minimal(base_size = 14)
```

## 8. County trends over time

Each county shows its own enrollment trend. Honolulu (Oahu) dominates overall enrollment but has seen the largest absolute decline.

```{r county-trends}
county_trend <- enr %>%
  filter(grade_level == "TOTAL", type == "COUNTY")

stopifnot(nrow(county_trend) > 0)
print(county_trend)

ggplot(county_trend, aes(x = end_year, y = n_students, color = county_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma) +
  labs(title = "Enrollment by County",
       subtitle = "Honolulu dominates but all counties affected by decline",
       x = "School Year", y = "Students", color = "") +
  theme_minimal(base_size = 14)
```

## 9. Special education enrollment

Hawaii tracks special education enrollment separately from regular grades in the DBEDT data. SPED data is suppressed in the most recent year per the Data Book footnote.

```{r special-ed}
sped <- enr_current %>%
  filter(type == "STATE", grade_level == "SPED")

if (nrow(sped) > 0) {
  total <- enr_current %>%
    filter(type == "STATE", grade_level == "TOTAL") %>%
    pull(n_students)
  cat("Special education students:", format(sped$n_students, big.mark = ","), "\n")
  cat("Percent of total enrollment:", sprintf("%.1f%%", sped$n_students / total * 100), "\n")
} else {
  cat("Special education data not separately reported for this year.\n")
}
```

## 10. Grade level distribution

Hawaii's enrollment by grade shows the typical K-12 distribution, with Grade 9 as the largest grade in 2025.

```{r grade-distribution}
grade_dist <- enr_current %>%
  filter(type == "STATE", !grade_level %in% c("TOTAL", "SPED")) %>%
  mutate(grade_level = factor(grade_level, levels = c("PK", "K", sprintf("%02d", 1:12))))

stopifnot(nrow(grade_dist) > 0)
print(grade_dist)

ggplot(grade_dist, aes(x = grade_level, y = n_students)) +
  geom_col(fill = "#2C3E50") +
  scale_y_continuous(labels = comma) +
  labs(title = "Enrollment by Grade Level",
       subtitle = paste("Hawaii Public Schools,", max_year),
       x = "Grade", y = "Students") +
  theme_minimal(base_size = 14)
```

## 11. Honolulu lost 14,170 students while neighbor islands lost only 3,399

Honolulu County (Oahu) has about two-thirds of all students, but neighbor island counties have maintained enrollment more effectively during the statewide decline.

```{r honolulu-vs-neighbor}
island_comparison <- enr %>%
  filter(grade_level == "TOTAL", type == "COUNTY") %>%
  mutate(island_group = ifelse(county_name == "Honolulu", "Honolulu (Oahu)", "Neighbor Islands")) %>%
  group_by(end_year, island_group) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE), .groups = "drop")

stopifnot(nrow(island_comparison) > 0)
print(island_comparison)

ggplot(island_comparison, aes(x = end_year, y = n_students, color = island_group)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  scale_color_manual(values = c("Honolulu (Oahu)" = "#2C3E50", "Neighbor Islands" = "#1ABC9C")) +
  labs(title = "Honolulu vs Neighbor Islands",
       subtitle = "Oahu dominates but faces steeper decline",
       x = "School Year", y = "Students", color = "") +
  theme_minimal(base_size = 14)
```

## 12. Elementary schools losing students faster than high schools

Elementary grades (K-5) have seen steeper enrollment declines than secondary grades (6-12), reflecting declining birth rates over the past decade.

```{r elementary-vs-secondary}
level_comparison <- enr %>%
  filter(type == "STATE", !grade_level %in% c("TOTAL", "SPED", "PK")) %>%
  mutate(level = case_when(
    grade_level %in% c("K", "01", "02", "03", "04", "05") ~ "Elementary (K-5)",
    grade_level %in% c("06", "07", "08") ~ "Middle (6-8)",
    TRUE ~ "High School (9-12)"
  )) %>%
  group_by(end_year, level) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE), .groups = "drop")

stopifnot(nrow(level_comparison) > 0)
print(level_comparison)

ggplot(level_comparison, aes(x = end_year, y = n_students, color = level)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c(
    "Elementary (K-5)" = "#3498DB",
    "Middle (6-8)" = "#F39C12",
    "High School (9-12)" = "#E74C3C"
  )) +
  labs(title = "Enrollment by School Level",
       subtitle = "Elementary schools losing students faster than high schools",
       x = "School Year", y = "Students", color = "") +
  theme_minimal(base_size = 14)
```

## 13. Maui lost 2,346 students since 2016 -- wildfires compound the decline

Maui County has seen enrollment drop from 21,080 to 18,734 since 2016. The 2023 Lahaina wildfire added new challenges to an already declining population.

```{r maui-n_students}
maui_trend <- enr %>%
  filter(grade_level == "TOTAL", county_name == "Maui")

stopifnot(nrow(maui_trend) > 0)
print(maui_trend)

ggplot(maui_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = "#9B59B6") +
  geom_point(size = 3, color = "#9B59B6") +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Maui County Enrollment",
       subtitle = "Tourism economy and wildfire impacts affect enrollment",
       x = "School Year", y = "Students") +
  theme_minimal(base_size = 14)
```

## 14. Pre-K enrollment holds steady around 1,600

Pre-Kindergarten enrollment has remained relatively stable around 1,600 students, fluctuating between 1,575 and 1,757 over the past decade.

```{r prek-trends}
prek_trend <- enr %>%
  filter(type == "STATE", grade_level == "PK")

stopifnot(nrow(prek_trend) > 0)
print(prek_trend)

ggplot(prek_trend, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = "#1ABC9C") +
  geom_point(size = 3, color = "#1ABC9C") +
  geom_vline(xintercept = 2020.5, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = Inf, label = "COVID", vjust = 2, color = "red", size = 3) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Pre-Kindergarten Enrollment",
       subtitle = "Stable around 1,600 students per year",
       x = "School Year", y = "Students") +
  theme_minimal(base_size = 14)
```

## 15. Big Island holds largest neighbor island enrollment

Hawaii County (Big Island) has the largest student population outside Oahu with 22,715 students, serving rural communities across a geographic area larger than all other Hawaiian islands combined.

```{r big-island-n_students}
neighbor_comparison <- enr_current %>%
  filter(grade_level == "TOTAL", type == "COUNTY", county_name != "Honolulu") %>%
  mutate(county_label = reorder(county_name, -n_students))

stopifnot(nrow(neighbor_comparison) > 0)
print(neighbor_comparison)

ggplot(neighbor_comparison, aes(x = county_label, y = n_students)) +
  geom_col(fill = "#E74C3C") +
  geom_text(aes(label = comma(n_students)), vjust = -0.5, size = 4) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(title = "Neighbor Island Enrollment",
       subtitle = "Hawaii County (Big Island) leads outside Oahu",
       x = "", y = "Students") +
  theme_minimal(base_size = 14)
```

## Session Info

```{r session-info}
sessionInfo()
```
